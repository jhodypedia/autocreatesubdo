<!doctype html>
<html>
<head><%- include('partials/head', { title: 'Admin Panel' }) %></head>
<body>
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Admin Panel â€” <%= domain %></h3>
      <div>
        <span class="me-3">Hi, <strong><%= adminUser %></strong></span>
        <a class="btn btn-sm btn-outline-secondary" href="/admin/logout">Logout</a>
      </div>
    </div>

    <% if (res && res.locals && res.locals.flash) { %>
      <script>Swal.fire({ icon: '<%= res.locals.flash.type === "success" ? "success" : "error" %>', title: "<%= res.locals.flash.msg %>", timer: 2500 });</script>
    <% } %>

    <div class="row">
      <div class="col-lg-4">
        <div class="card shadow-sm mb-3 p-3">
          <h5>Site Stats</h5>
          <p>Total Subdomains: <strong><%= totalSubs %></strong></p>
          <a href="/admin/export/csv" class="btn btn-sm btn-outline-primary">Export CSV</a>
        </div>

        <div class="card shadow-sm mb-3 p-3">
          <h5>Reserved Names</h5>
          <ul class="list-group mb-2">
            <% reserved.forEach(r => { %>
              <li class="list-group-item"><%= r %></li>
            <% }) %>
          </ul>
          <form action="/admin/reserve" method="post" class="d-flex">
            <input class="form-control form-control-sm me-2" name="name" placeholder="add reserved">
            <button class="btn btn-sm btn-success">Add</button>
          </form>
        </div>

        <div class="card shadow-sm p-3">
          <h5>Adsterra Script</h5>
          <form action="/admin/settings" method="post">
            <input type="hidden" name="ADSTERRA_SCRIPT" value="">
            <textarea name="ADSTERRA_SCRIPT" rows="4" class="form-control mb-2"><%= settings && settings.ADSTERRA_SCRIPT ? settings.ADSTERRA_SCRIPT : '' %></textarea>
            <button class="btn btn-sm btn-primary">Save Script</button>
          </form>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="card shadow-sm p-3 mb-3">
          <h5>Service Settings</h5>
          <form action="/admin/settings" method="post">
            <div class="row g-2">
              <div class="col-md-6"><label class="form-label">Cloudflare API Token</label><input class="form-control form-control-sm" name="CF_API_TOKEN" value="<%= settings.CF_API_TOKEN || '' %>"></div>
              <div class="col-md-6"><label class="form-label">Cloudflare Zone ID</label><input class="form-control form-control-sm" name="CF_ZONE_ID" value="<%= settings.CF_ZONE_ID || '' %>"></div>
              <div class="col-md-6"><label class="form-label">Turnstile Site Key</label><input class="form-control form-control-sm" name="TURNSTILE_SITEKEY" value="<%= settings.TURNSTILE_SITEKEY || '' %>"></div>
              <div class="col-md-6"><label class="form-label">Turnstile Secret</label><input class="form-control form-control-sm" name="TURNSTILE_SECRET" value="<%= settings.TURNSTILE_SECRET || '' %>"></div>
              <div class="col-md-6"><label class="form-label">Adsterra Publisher API Key</label><input class="form-control form-control-sm" name="ADSTERRA_PUBLISHER_API_KEY" value="<%= settings.ADSTERRA_PUBLISHER_API_KEY || '' %>"></div>
              <div class="col-md-6"><label class="form-label">Adsterra Domain ID</label><input class="form-control form-control-sm" name="ADSTERRA_DOMAIN_ID" value="<%= settings.ADSTERRA_DOMAIN_ID || '' %>"></div>
              <div class="col-md-6"><label class="form-label">Daily Create Limit</label><input class="form-control form-control-sm" name="DAILY_CREATE_LIMIT" value="<%= settings.DAILY_CREATE_LIMIT || '3' %>"></div>
              <div class="col-md-6 form-check align-self-end">
                <input class="form-check-input" type="checkbox" id="blockvpn" name="BLOCK_VPN" value="true" <%= settings.BLOCK_VPN === 'true' ? 'checked' : '' %> />
                <label class="form-check-label" for="blockvpn">Block VPN/hosting (IPInfo)</label>
              </div>
              <div class="col-12 mt-2"><label class="form-label">IPInfo Token (optional)</label><input class="form-control form-control-sm" name="IPINFO_TOKEN" value="<%= settings.IPINFO_TOKEN || '' %>"></div>
              <div class="col-12 mt-2"><button class="btn btn-primary btn-sm">Save Settings</button></div>
            </div>
          </form>
        </div>

        <div class="card shadow-sm p-3 mb-3">
          <h5>Adsterra Stats (Last 30 days)</h5>
          <% if (adStats && adStats.data) { %>
            <p>Total rows: <%= (adStats.count || adStats.total || adStats.data.length) %></p>
            <canvas id="revenueChart"></canvas>
            <canvas id="clickChart" class="mt-3"></canvas>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
              const daily = <%- JSON.stringify(adStats.data || []) %>;
              const labels = daily.map(d => d.date);
              const earnings = daily.map(d => Number(d.earnings || d.revenue || 0));
              const clicks = daily.map(d => Number(d.clicks || 0));
              new Chart(document.getElementById('revenueChart'), { type:'line', data:{ labels, datasets:[{ label:'Earnings', data:earnings, tension:0.3, fill:true }] }});
              new Chart(document.getElementById('clickChart'), { type:'bar', data:{ labels, datasets:[{ label:'Clicks', data:clicks }] }});
            </script>
          <% } else { %>
            <div class="alert alert-warning">Adsterra stats not configured or failed to fetch. Set Publisher API key & domain id in settings.</div>
          <% } %>
        </div>

        <div class="card shadow-sm p-3">
          <h5>Subdomains</h5>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead><tr><th>Name</th><th>Target</th><th>Owner IP</th><th>Created</th><th>Action</th></tr></thead>
              <tbody>
                <% subs.forEach(s => { %>
                  <tr>
                    <td><%= s.name %>.<%= domain %></td>
                    <td><%= s.target %></td>
                    <td><%= s.owner %></td>
                    <td><%= s.created_at %></td>
                    <td>
                      <form method="post" action="/admin/delete/<%= s.name %>" style="display:inline;">
                        <button class="btn btn-sm btn-danger del-btn">Delete</button>
                      </form>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/app.js"></script>
  <script>
    document.querySelectorAll('.del-btn').forEach(btn => {
      btn.addEventListener('click', function(e){
        e.preventDefault();
        const form = this.closest('form');
        Swal.fire({
          title: 'Delete subdomain?',
          text: 'This will remove DNS record and database entry.',
          icon: 'warning',
          showCancelButton: true
        }).then(r => { if (r.isConfirmed) form.submit(); });
      });
    });
  </script>
</body>
</html>
